<head>
<script>
    msxColors=[
        [0,0,0],[1,1,1],
        [62,184,73],[116,208,125],//green

        [89,85,224],[128,118,241],//blue

        [185,94,81],//red
        [101,219,239],//blue
        [219,101,89],[255,137,125],//red
        [204,195,94],[222,208,135],//yellow
        [58,162,65],//green
        [183,102,181],//mag
        [204,204,204],//gray
        [255,255,255],//white
        
    ];


    

    function findSkips(a,v){//array,value
        var c=[0];
        var l=a.length*a[0].length;
        var i=-1;
        var j=0;
        var s=false;var p;
        while(++i<l){
            p=a[Math.floor(i/a[0].length)][i%a[0].length]
            
            if(s == (p==v))
                c[j]++;
            else
                {s=!s;c[++j]=0;i--;}
        }
        return c;
    }

    function buildSkips(c,v,length){

        var s=false;
        var j=0;
        var a=[];
        var i;
        i=-1;while(c.length>0){
            i++;
            if (a[Math.floor(i/length)]===undefined)a[Math.floor(i/length)]=[];
            if(c[0]>0)
                {c[0]--;a[Math.floor(i/length)][i%length]=s?v:0;}
            else
                {c.shift();s=!s;i--;}

        }
        return a;
    }

    function arraysToMSX(a,vals,w=128,h=128){
        var result="";
        document.getElementById("code").innerHTML="10 w="+w+":h="+h+":q="+vals.length+"<br>";
        var i=-1;var n=1001;while(++i<a.length){
            result+=(i+n)+" DATA "+a[i].length+","+vals[i]+"<br>"
            var A=a[i];
            while(A.length>0){
                n++;
                result+=(i+n)+" DATA "+A.splice(0,10).toString()+"<br>";
            }
            n++;
            //a[i].toString()+"<br>";
        }
        document.getElementById("data").innerHTML=result;
        return result;
    }

    function loadImage(){
        var f=URL.createObjectURL(document.getElementById("file").files[0]);
        
        var img=new Image();
        img.onload=function(){
            c.width=img.width;
            c.height=img.height;
            cx.drawImage(img,0,0,img.width,img.height);
            var a=readCanvas(0,0,img.width,img.height);
            a=(compileArray(a));
            arraysToMSX(a[0],a[1],img.width,img.height);
        };
        img.src=f;
    }

    function readCanvas(x,y,w,h){
        var i,j;
        var a=[];for (i=0;i<h;i++)a[i]=[];


        var data=cx.getImageData(x,y,w,h).data;

        //find colors
        var c={};
        for (i=0;i<data.length;i+=4){
            j=data[0]+","+data[1]+","+data[2];
            c[j]=[data[0],data[1],data[2]];
        }
        var I;
        for (i=0;i<data.length;i+=4){
            I=i/4;
            j=matchingColor([data[i],data[i+1],data[i+2]]);
            a[I%w][Math.floor(I/w)]=j;
        }

        return a;
    }

    //find msxColor mathcing provided color
    function matchingColor(c){
        var dp=999999;var r=0;
        var d;
        for (var i=0;i<msxColors.length;i++){
            var C=msxColors[i];
            d=Math.pow(c[0]-C[0],2)+Math.pow(c[1]-C[1],2)+Math.pow(c[2]-C[2],2);
            if(d<dp){dp=d;r=i;}
        }
        return r;
    }

    function compileArray(a){
        var r=[];var vals=[];
        for (var i=0;i<msxColors.length;i++){
            var s=findSkips(a,i);
            if(s.length>1){
                r.push(s);
                vals.push(i);
            }
        }
        return [r,vals];
    };
</script>
</head>

<body>
    <input type="file" id="file" onchange="loadImage()" />
    <canvas id="canvas"></canvas>
    <br>
<div id="code">
    10 w=4:h=4:q=2<br>
11 data 5,1 ,4,3,5,2,2<br>
12 data 4,5 ,1,3,4,1<br>
<br>
    </div>
    20 l=w*h-1<br>
    30 screen 5<br>
    50 i=0:j=-1:read s,v<br>
    60 for j=0 to s-1:read c<br>
    80 if c=0 then goto 90<br>
    81 c=c-1:k=(j and 1)*v<br>
    82 if (j and 1 <>0) then pset(i/w,i mod w),v<br>
    83 i=i+1: goto 80<br>
    90 next: q=q-1:if q>0 then goto 50<br>
<br>
100 goto 100<br>
<!--
200 screen 5<br>
205 for i=0 to l<br>
210 if i mod w=0 then print "---"<br>
220 pset(i mod w,i/h),a(i mod w,i/h)<br>
230 next<br>
240 goto 240<br>
-->
<div id="data"></div>
</body>
<script>
    var c=document.getElementById("canvas");
        var cx=c.getContext('2d');
</script>