<!DOCTYPE html>
<html>
    <head>
        <title>importing test</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src='../google/tensorflow2.7.0.min.js'></script>
        <script src='../TFLayerPath.js'></script>
        <script src='../GuzuTFPlugins.js'></script>
        <script src="../GuzuDataTools.js"></script>
        <script src="../layerFixedConv2d.js"></script>
        <script>
            //model maker
            var p=tf.util.path();
            p.add("in",tf.input({shape:[48,48,1]}));
            p.to("f",tf.layers.flatten());
            p.to("d1",tf.layers.dense({units:10}));
            //p.to("count",tf.layers.bbox());

            var m=p.Model();//=p.model(["in"],["in"]);//tf.model({inputs:[p.get("in")],outputs:[p.apply()]});
        </script>
        <script>

            var c,cx;
            function onload(){
                c=document.getElementById("c");//new OffscreenCanvas(256, 256);
                cx=c.getContext('2d');
                cx.textAlign="center";
                cx.textBaseline="middle";
            }
        
            var fonts=[
                "sans-serif",//
                "Monospace",//
                "Arial",
                "Times New Roman",
                "Helvetica",
                "Courier New",
                "Verdana",
                "Arial Narrow",
                "Candara",
                "Calibri",
                "Cambria",
                "Impact",
                "Georgia",
                "Trebuchet MS",
                "Comic Sans MS"
            ];
            function draw(text,fontNumber,sizeoffset=0,xoffset=0,yoffset=0,rotate){
                cx.font=(sizeoffset+20)+"px "+fonts[fontNumber||0];
                
                cx.clearRect(0,0,48,48);
                
                cx.translate(24+xoffset,24+yoffset);
                cx.rotate(rotate*Math.PI/180);
                cx.fillText(text,0,0);
                cx.resetTransform();
            }

            function drawRandom(){
                var r;
                draw(r=Math.floor(Math.random()*10),Math.floor(Math.random()*fonts.length),Math.random()*4-8,Math.random()*8-16,Math.random()*5-10,-20+Math.random()*40)
                return r;
            }

            var t1;
            //idea to convert imagedata to tensor
            function test(){
                var a=cx.getImageData(0,0,48,48).data;
                t1=tf.tensor(Array.from(a),[48,48,4]);
                t1=tf.guzu.removeChannels(t1,[0,1,2]);
                t1.max().print();
            }

            function makeDataset(size=32){
                return tf.tidy(()=>{
                    var inputs=[],outputs=[],a;
                    for(var i=0;i<size;i++){
                        outputs.push(drawRandom());
                        a=cx.getImageData(0,0,48,48).data;
                        inputs.push(Array.from(a));
                    }
                    inputs=tf.tensor(inputs,[size,48,48,4]);
                    outputs=tf.tensor(outputs,[size]);
                    inputs=tf.guzu.removeChannels(inputs,[0,1,2]);
                    return [inputs,tf.oneHot(outputs.cast('int32'),10)];
                });
            }

            function remakeDataset(src,keep){
                if(keep===undefined)
                    keep=Math.ceil(src[0].shape[0]/2);
                console.log(src[0].shape[0],keep);
                var r=tf.tidy(()=>{
                    var s=src.concat();
                    var j=makeDataset(s[0].shape[0]-keep);
                    if(keep<1)
                        return j;
                    
                    s[0]=tf.slice(s[0],keep).concat(j[0]);
                    s[1]=tf.slice(s[1],keep).concat(j[1]);
                    
                    return s;
                });
                src[0].dispose();
                src[1].dispose();
                src[0]=r[0];src[1]=r[1];
                return r;
            }

        </script>
    <body onload="onload()">
        <canvas id="c" width=48 height=48></canvas>
    </body>
</html>